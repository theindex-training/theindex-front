<section class="page">
  <header class="page-header">
    <div>
      <h1>Attendance</h1>
      <p>Review training sessions and all registered attendees.</p>
    </div>
    <div class="page-actions">
      <a class="button button-primary" routerLink="/attendance/new">Register attendance</a>
    </div>
  </header>

  <section class="filters">
    <label class="field">
      <span>Start date</span>
      <input type="date" [(ngModel)]="selectedStartDate" />
    </label>

    <label class="field">
      <span>End date</span>
      <input type="date" [(ngModel)]="selectedEndDate" />
    </label>

    <label class="field">
      <span>Start time</span>
      <input type="time" [(ngModel)]="selectedStartTime" />
    </label>

    <label class="field">
      <span>End time</span>
      <input type="time" [(ngModel)]="selectedEndTime" />
    </label>

    @if (isAdmin) {
      <label class="field">
        <span>Trainer</span>
        <select [(ngModel)]="selectedTrainerId" [disabled]="loadingTrainers">
          <option value="">All trainers</option>
          @for (trainer of trainers; track trainer.id) {
            <option [value]="trainer.id">
              {{ trainer.name }}{{ trainer.nickname ? ' (' + trainer.nickname + ')' : '' }}
            </option>
          }
        </select>
      </label>
    }

    <label class="field">
      <span>Session bucket</span>
      <select [(ngModel)]="selectedBucketMinutes">
        <option [ngValue]="null">Default</option>
        <option [ngValue]="30">30 min</option>
        <option [ngValue]="45">45 min</option>
        <option [ngValue]="60">60 min</option>
        <option [ngValue]="90">90 min</option>
        <option [ngValue]="120">120 min</option>
      </select>
    </label>

    <button class="button button-secondary" type="button" (click)="loadSessions()">Apply</button>
  </section>

  @if (loading) {
    <div class="state">Loading attendance sessions...</div>
  } @else if (errorMessage) {
    <div class="state error">{{ errorMessage }}</div>
  } @else if (!sessions.length) {
    <div class="state">No attendance sessions found for the selected filters.</div>
  } @else {
    <div class="tabs" role="tablist" aria-label="Attendance sessions">
      @for (session of sessions; track trackBySession($index, session)) {
        <button
          class="tab"
          type="button"
          role="tab"
          [attr.aria-selected]="isSessionSelected(session.sessionKey)"
          [class.active]="isSessionSelected(session.sessionKey)"
          (click)="toggleSession(session.sessionKey)"
        >
          {{ sessionTabTitle(session) }}
        </button>
      }
    </div>

    @if (selectedSessions.length) {
      <section class="selection-summary" aria-label="Selected sessions summary">
        <span>Selected sessions: <strong>{{ selectedSessionsSummary.sessions }}</strong></span>
        <span>Attendance: <strong>{{ selectedSessionsSummary.attendance }}</strong></span>
        <span>Paid: <strong>{{ selectedSessionsSummary.paid }}</strong></span>
        <span>Unpaid: <strong>{{ selectedSessionsSummary.unpaid }}</strong></span>
        <span>Final price total: <strong>{{ formatPrice(selectedSessionsSummary.finalPriceCents) }}</strong></span>
      </section>
    }

    @if (!selectedSessions.length) {
      <div class="state">Select one or more sessions to view attendance details.</div>
    }

    @for (session of selectedSessions; track trackBySession($index, session)) {
      <article class="card session-card">
        <header class="session-header">
          <h2>
            {{ formatDateTime(session.start) }} - {{ formatDateTime(session.end) }} ·
            {{ formatDate(session.start) }}
          </h2>
          <p>
            Trainer: <strong>{{ formatTrainer(session) }}</strong>
            · Gym: <strong>{{ locationName(session.locationId) }}</strong>
          </p>
          <p>
            Total: <strong>{{ session.totals.count }}</strong>
            · Paid: <strong>{{ session.totals.paid }}</strong>
            · Unpaid: <strong>{{ session.totals.unpaid }}</strong>
            · Price total: <strong>{{ sessionTotalPrice(session) }}</strong>
          </p>
        </header>

        <div class="attendees">
          <div class="attendees-header" [class.with-actions]="canDeleteSessionAttendance(session)">
            <span>Trainee</span>
            <span>Nickname</span>
            <span>Status</span>
            <span>Price</span>
            @if (canDeleteSessionAttendance(session)) {
              <span>Actions</span>
            }
          </div>

          @for (item of session.attendance; track item.id) {
            <div class="attendee-row" [class.with-actions]="canDeleteSessionAttendance(session)">
              <span>{{ traineeName(item.traineeId) }}</span>
              <span>{{ traineeNickname(item.traineeId) }}</span>
              <span>
                <span class="status" [class.unpaid]="item.paymentStatus === 'UNPAID'">
                  {{ item.paymentStatus }}
                </span>
              </span>
              <span>{{ attendancePrice(item) }}</span>
              @if (canDeleteSessionAttendance(session)) {
                <span class="action-cell">
                  <button
                    class="button button-danger button-small"
                    type="button"
                    (click)="deleteAttendance(session, item)"
                    [disabled]="deletingAttendanceId === item.id"
                  >
                    {{ deletingAttendanceId === item.id ? 'Deleting...' : 'Delete' }}
                  </button>
                </span>
              }
            </div>
          }
        </div>
      </article>
    }
  }
</section>
